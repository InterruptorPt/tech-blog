---
title: 'Web Monetization: Parte 2 - Verificar atividade'
date: '2021-07-29'
author: Ciaran Edwards
translator: Rute Correia
description: Como garantir que o s√≠tio web responde quando recebe pagamentos atrav√©s de Web Monetization. Tutorial passo-a-passo com React e TypeScript.
image: /images/on-off-buttons.jpg
imageCredit: Fotografia por <a href="https://unsplash.com/@justusmenke?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Justus Menke</a> via <a href="https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a>
imageAlt: 'Bot√µes de "on" e "off"'
---

Depois de configurar o apontador de pagamentos, a pr√≥xima coisa a fazer √© verificar se estamos a receber pagamentos atrav√©s de Web Monetization e responder a isso, usando a [API de JavaScript](https://webmonetization.org/docs/api).

Apesar de bastar algo como `document.monetization === 'started'` para fazer essa verifica√ß√£o, se estivermos a usar uma _framework_ como React, conv√©m que a p√°gina atualize sempre que o processo de pagamento inicie ou termine.

üí° _O nosso s√≠tio web est√° constru√≠do em React, pelo que as amostras de c√≥digo usam React. Os princ√≠pios s√£o bastante simples, contudo. Por isso, n√£o dever√° ser demasiado dif√≠cil de afinar o c√≥digo para que encaixe em qualquer framework que esteja a ser usada._

## Passo 0: Avisar o TypeScript do Web Monetization

Caso esteja a ser usado TypeScript, √© preciso avis√°-lo que o `document` agora tem uma propriedade, `monetization`. Ou, mais especificamente, que _pode_ ter uma propriedade `monetization`. Felizmente para n√≥s, a Coil criou um pacote com todos os tipos necess√°rios √† implementa√ß√£o do Web Monetization. Vamos instal√°-lo:

```sh
npm install --save-dev @webmonetization/types
```

Assim, podemos adicionar a propriedade `monetization` √† interface global do `Document` interface, deste modo:

```ts
import { MonetizationObject } from '@webmonetization/types'

declare global {
  interface Document {
    monetization?: MonetizationObject
  }
}
```

Agora, o TypeScript j√° sabe que existe Web Monetization! üéâ

## Passo 1: Adicionar ouvintes de eventos

Para descobrir se h√° eventos de monetiza√ß√£o a acontecer, pode-se usar `document.monetization.addEventListener`.

```ts
document.monetization.addEventListener(eventName, (event) => {
  doSomeStuff(event)
})
```

No entanto, √© preciso ter em aten√ß√£o duas coisas:

1. Antes de tentarmos adicionar ouvintes de eventos, temos sempre de verificar se existe `document.monetization` para podermos adicion√°-los.
1. Devemos certificar-nos que removemos o ouvinte do evento, quando j√° n√£o estamos a us√°-lo.

Ent√£o, vamos criar uma fun√ß√£o que resolva ambas as quest√µes:

```ts
import {
  MonetizationEventMap,
  MonetizationEventType,
} from '@webmonetization/types'
import { TEventListener } from '@webmonetization/types/build/genericEventListeners'

/**
 * Isto adiciona um ouvinte do evento de monetiza√ß√£o e devolve uma fun√ß√£o
 * que podemos chamar para remov√™-lo mais tarde
 */
const addEventListener = <TEvent extends MonetizationEventType>(
  event: TEvent,
  eventListener: TEventListener<MonetizationEventMap[TEvent]>,
): (() => void) => {
  document.monetization?.addEventListener(event, eventListener, {
    passive: true,
  })

  return () => document.monetization?.removeEventListener(event, eventListener)
}
```

Isto vai dar jeito quando adicionarmos ouvintes de eventos com `useEffect` ‚Äì podemos adicionar um ouvinte e depois remov√™-lo com uma fun√ß√£o de limpeza:

```tsx
useEffect(() => {
  const removeListener = addEventListener('monetizationprogress', (event) => {
    console.log('Check out all this cash money üí∏', event.detail)
  })

  return () => {
    removeEventListener()
  }
}, [])
```

## Passo 2: Armazenar o estado atual do Web Monetization num estado global

Agora que j√° sabemos verificar quando estamos a receber pagamentos, queremos que os componentes do nosso s√≠tio _web_ reajam sempre que os pagamentos comecem ou parem. Para este exemplo, vamos usar a Context API do React.

Primeiro, criamos o contexto:

```ts
import React from 'react'
import { MonetizationState } from '@webmonetization/types'

type WebMonetizationContextValue = {
  state: MonetizationState // "pending" | "started" | "stopped"
}

const WebMonetizationContext = React.createContext<
  WebMonetizationContextValue | undefined
>(undefined)
```

Inicializar o contexto com `undefined` √© um pequeno truque que uso para ter a certeza que n√£o tento aceder ao `WebMonetizationContext` acidentalmente, fora do `Provider`. Se definires um valor padr√£o ao usar o _React Context_, podes esquecer-te de encapsular a tua aplica√ß√£o com o componente `Provider` sem nunca te aperceberes. J√° me aconteceu ser apanhado em coisas assim algumas vezes, por isso permito que o valor esteja `undefined`, e depois crio um _hook_ que dispara um erro se o valor do contexto estiver em falta.

```ts
export const useWebMonetization = (): WebMonetizationContextValue => {
  const webMonetizationContext = useContext(WebMonetizationContext)

  if (!webMonetizationContext) {
    throw new Error(
      `[WebMonetizationContext] You're using the context outside of the WebMonetizationProvider üò¨`,
    )
  }

  return webMonetizationContext
}
```

O pr√≥ximo passo √© fazer o nosso componente personalizado `WebMonetizationProvider`. √â a√≠ que vamos configurar os nossos ouvintes de evento para acompanhar o estado atual de monetiza√ß√£o, e depois definir o valor do nosso `WebMonetizationContext`.

```tsx
export const WebMonetizationProvider: React.FC = ({ children }) => {
  const [state, setState] = useState<MonetizationState>('pending')

  useEffect(() => {
    const onStart = () => setState('started')
    const onStop = () => setState('stopped')

    const events = [
      addEventListener('monetizationstart', onStart),
      addEventListener('monetizationprogress', onStart),
      addEventListener('monetizationstop', onStop),
    ]

    return () => {
      events.forEach((removeListener) => removeListener())
    }
  }, [setState])

  return (
    <WebMonetizationContext.Provider value={{ state }}>
      {children}
    </WebMonetizationContext.Provider>
  )
}
```

A √∫nica coisa que falta √© encapsular a aplica√ß√£o com `WebMonetizationProvider`, e est√° tudo pronto para que possas come√ßar a usar o `context` nos teus componentes.

## Passo 3: Reagir a eventos de monetiza√ß√£o

Agora que a nossa aplica√ß√£o est√° configurada para acompanhar eventos de monetiza√ß√£o, provavelmente s√≥ h√° mais um pormenor que nos interessa: _"Est√° ligado ou n√£o?"_

Vamos criar mais um _hook_ para verificar isso mesmo:

```ts
export const useIsWebMonetizationActive = (): boolean => {
  const { state } = useWebMonetization()

  return state === 'started'
}
```

Podes usar este _hook_ em qualquer componente para verificar se √© para mostrar conte√∫do adicional, desativar an√∫ncios ou qualquer outra coisa que queiras oferecer a visitantes que usem o protocolo Web Monetization.

No Interruptor, estamos s√≥ a come√ßar a implementar isto. Por isso, para j√°, temos apenas um componente `WebMonetizationToaster` que mostra uma notifica√ß√£o a dizer "Obrigado" quando o Web Monetization est√° ativo.

```tsx
import React, { useEffect } from 'react'
import { useTranslation } from 'react-i18next'
import { toast } from 'react-toastify'

import { AnalyticsEvent, trackEvent } from 'utils/analytics'
import { useIsWebMonetizationActive } from 'utils/monetization'

export const WebMonetizationToaster: React.FC = () => {
  const { t } = useTranslation('monetization')
  const isMonetizationActive = useIsWebMonetizationActive()

  useEffect(() => {
    if (!isMonetizationActive) return

    // Show the thank-you message
    toast.success(t('thanks'))
  }, [isMonetizationActive, t])

  useEffect(() => {
    if (!isMonetizationActive) return

    // Send an event to Plausible so we can see how many visitors use it
    trackEvent(AnalyticsEvent.WEB_MONETIZATION_ACTIVE)
  }, [isMonetizationActive])

  return null
}
```

E parece-se assim:

<img
  alt="Screenshot of the Interruptor website showing a thank-you message"
  src="/images/web-monetization-thank-you-toast.png"
  width="600"
  height="676"
/>

Para j√°, √© tudo o que temos, mas vamos desenvolver novas funcionalidades nos pr√≥ximos meses e escrever sobre elas aqui - por isso, n√£o percas o pr√≥ximo artigo.
